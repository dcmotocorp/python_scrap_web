data_list = [    'https://www.catch.com.au/shop/electronics/cameras', 'https://www.catch.com.au/shop/electronics/drones', 'https://www.catch.com.au/shop/electronics/gaming', 'https://www.catch.com.au/shop/electronics/home-security', 'https://www.catch.com.au/shop/electronics/power', 'https://www.catch.com.au/shop/electronics/phones-smart-tech', 'https://www.catch.com.au/shop/electronics/music', 'https://www.catch.com.au/shop/electronics/catch-mobile']

com = ['https://www.catch.com.au/shop/home-kitchen/bedding', 'https://www.catch.com.au/shop/home-kitchen/home-decor', 'https://www.catch.com.au/shop/home-kitchen/arts-crafts-sewing', 'https://www.catch.com.au/shop/home-kitchen/kitchen', 'https://www.catch.com.au/shop/home-kitchen/festive-party-supplies', 'https://www.catch.com.au/shop/home-kitchen/stationery', 'https://www.catch.com.au/shop/home-kitchen/bathroom', 'https://www.catch.com.au/shop/home-kitchen/outdoor', 'https://www.catch.com.au/shop/home-kitchen/books-media', 'https://www.catch.com.au/shop/home-kitchen/home-storage', 'https://www.catch.com.au/shop/home-kitchen/rugs', 'https://www.catch.com.au/shop/home-kitchen/personalised', 'https://www.catch.com.au/shop/home-kitchen/dining','https://www.catch.com.au/shop/home-kitchen/tools-hardware', 'https://www.catch.com.au/shop/home-kitchen/diy', 'https://www.catch.com.au/shop/beauty/makeup', 'https://www.catch.com.au/shop/beauty/bath-body', 'https://www.catch.com.au/shop/beauty/mens-grooming', 'https://www.catch.com.au/shop/beauty/aromatherapy', 'https://www.catch.com.au/shop/beauty/skincare','https://www.catch.com.au/shop/beauty/fragrance','https://www.catch.com.au/shop/beauty/beauty-grooming',  'https://www.catch.com.au/shop/beauty/hair-care', 'https://www.catch.com.au/shop/beauty/toiletries', 'https://www.catch.com.au/shop/beauty/dental-oral-care', 'https://www.catch.com.au/shop/beauty/manicure-pedicure','https://www.catch.com.au/shop/grocery-liquor/snacks','https://www.catch.com.au/shop/grocery-liquor/international-foods', 'https://www.catch.com.au/shop/grocery-liquor/confectionery', 'https://www.catch.com.au/shop/grocery-liquor/beverage', 'https://www.catch.com.au/shop/grocery-liquor/home-car-cleaning', 'https://www.catch.com.au/shop/grocery-liquor/healthy-foods', 'https://www.catch.com.au/shop/grocery-liquor/breakfast','https://www.catch.com.au/shop/grocery-liquor/pantry-staples', 'https://www.catch.com.au/shop/grocery-liquor/baby-food', 'https://www.catch.com.au/shop/grocery-liquor/pets', 'https://www.catch.com.au/shop/grocery-liquor/liquor', 'https://www.catch.com.au/shop/grocery-liquor/vitamins-medicinal', 'https://www.catch.com.au/shop/grocery-liquor/toiletries', 'https://www.catch.com.au/shop/grocery-liquor/shop-all-pantry', 'https://www.catch.com.au/shop/pets/food-and-treats', 'https://www.catch.com.au/shop/pets/pet-medicine', 'https://www.catch.com.au/shop/pets/pet-accessories', 'https://www.catch.com.au/shop/pets/toys', 'https://www.catch.com.au/shop/pets/bedding', 'https://www.catch.com.au/shop/pets/kennels', 'https://www.catch.com.au/shop/pets/cat-scratchers', 'https://www.catch.com.au/shop/pets/carriers-cages', 'https://www.catch.com.au/shop/sports-outdoor/men', 'https://www.catch.com.au/shop/sports-outdoor/boys', 'https://www.catch.com.au/shop/sports-outdoor/bat-ball-sports-equipment', 'https://www.catch.com.au/shop/sports-outdoor/ball-sports-equipment', 'https://www.catch.com.au/shop/sports-outdoor/women', 'https://www.catch.com.au/shop/sports-outdoor/girls', 'https://www.catch.com.au/shop/sports-outdoor/racquet-sports-equipment', 'https://www.catch.com.au/shop/sports-outdoor/camping-hiking', 'https://www.catch.com.au/shop/sports-outdoor/accessories', 'https://www.catch.com.au/shop/sports-outdoor/health-wellbeing', 'https://www.catch.com.au/shop/sports-outdoor/gym-equipment', 'https://www.catch.com.au/shop/sports-outdoor/outdoor-sport-activities', 'https://www.catch.com.au/shop/toys-games/kids-toys-games', 'https://www.catch.com.au/shop/toys-games/books', 'https://www.catch.com.au/shop/toys-games/baby-toys-activities', 'https://www.catch.com.au/shop/toys-games/art-craft', 'https://www.catch.com.au/shop/toys-games/radio-control-toys', 'https://www.catch.com.au/shop/toys-games/costumes-novelty', 'https://www.catch.com.au/shop/kids-clothing-toys/girls-clothing', 'https://www.catch.com.au/shop/kids-clothing-toys/kids-accessories', 'https://www.catch.com.au/shop/kids-clothing-toys/kids-bedroom', 'https://www.catch.com.au/shop/kids-clothing-toys/boys-clothing', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-sleep-products', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-bedding', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-bath-products', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-feeding', 'https://www.catch.com.au/shop/kids-clothing-toys/nappies-on-sale', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-safety', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-clothing', 'https://www.catch.com.au/shop/kids-clothing-toys/baby-travel', 'https://www.catch.com.au/shop/kids-clothing-toys/personalised', 'https://www.catch.com.au/shop/furniture/dining-kitchen', 'https://www.catch.com.au/shop/furniture/storage-organisation', 'https://www.catch.com.au/shop/furniture/nursery-furniture', 'https://www.catch.com.au/shop/furniture/living-room', 'https://www.catch.com.au/shop/furniture/outdoor', 'https://www.catch.com.au/shop/furniture/rugs', 'https://www.catch.com.au/shop/furniture/bedroom', 'https://www.catch.com.au/shop/furniture/office', 'https://www.catch.com.au/shop/furniture/kids', 'https://www.catch.com.au/shop/appliances/cooking-dishwashers', 'https://www.catch.com.au/shop/appliances/vacuum-floorcare', 'https://www.catch.com.au/shop/appliances/coffee-machines-beverage', 'https://www.catch.com.au/shop/appliances/specialty-appliances', 'https://www.catch.com.au/shop/appliances/fridges-freezers', 'https://www.catch.com.au/shop/appliances/laundry', 'https://www.catch.com.au/shop/appliances/benchtop-cooking', 'https://www.catch.com.au/shop/appliances/healthcare', 'https://www.catch.com.au/shop/appliances/heating-cooling', 'https://www.catch.com.au/shop/appliances/toaster-kettle', 'https://www.catch.com.au/shop/appliances/mixers-food-processor', 'https://www.catch.com.au/shop/appliances/bathroom', 'https://www.catch.com.au/shop/electronics/audio-speakers', 'https://www.catch.com.au/shop/electronics/headphones', 'https://www.catch.com.au/shop/electronics/home-cinema-tv-video', 'https://www.catch.com.au/shop/electronics/car-electronics', 'https://www.catch.com.au/shop/electronics/computers-laptops', 'https://www.catch.com.au/shop/electronics/digital-storage', 'https://www.catch.com.au/shop/electronics/tablet-ereader', 'https://www.catch.com.au/shop/electronics/printers-scanners',  ]



import logging
from selenium import webdriver
from bs4 import BeautifulSoup
import csv
import time
import string
import random
from selenium.webdriver.common.by import By
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.support.ui import WebDriverWait
from concurrent.futures import ThreadPoolExecutor, wait,ProcessPoolExecutor
from selenium.common.exceptions import WebDriverException
import  shutil
import json,os,time

from selenium.webdriver.common.action_chains import ActionChains





import ctypes
logging.getLogger('selenium').setLevel(logging.WARNING)
# Set maximum memory allocation to 4 GB
soft_limit = 4 * 1024 * 1024 * 1024  # 4 GB in bytes

# Get a handle to the current process
process_handle = ctypes.windll.kernel32.GetCurrentProcess()

# Set the maximum working set size
ctypes.windll.kernel32.SetProcessWorkingSetSizeEx(
    process_handle,
    ctypes.c_size_t(-1),
    ctypes.c_size_t(soft_limit),
    ctypes.c_uint(0)
)




threadss = ThreadPoolExecutor(max_workers=3)
processes = ProcessPoolExecutor(max_workers=2)

workers = 3
process_worker = 2
filename = "products.csv"

main_page_url = 'https://www.catch.com.au/shop'
domain_url = "https://www.catch.com.au"

url = 'https://www.catch.com.au/shop/home-kitchen/bedding'
base_url = "https://www.catch.com.au"



def get_product_links(url,file_name, count=1):  
    product_links = []
    url = url + f"?f%5Bseller_type%5D=catch&page={count}"
    try:
        star = time.time()        
        chrome_options = Options()
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--disable-gpu")
        chrome_options.add_argument("--disable-software-rasterizer")
        chrome_options.add_argument("--disable-extensions")
        chrome_options.add_argument("--disable-infobars")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-images")
        chrome_options.add_argument("--disable-javascript")
        chrome_options.add_argument("--disable-web-security")
        chrome_options.add_argument("--disable-features=AnimationWorklet")
        chrome_options.add_argument("--disable-features=CSSLayoutNG")
        chrome_options.add_argument("--ignore-certificate-errors")
        # chrome_options.add_argument("--disable-webgl")
        chrome_options.add_argument("--js-flags=--max-old-space-size=4096")
        chrome_options.add_argument('--blink-settings=imagesEnabled=false')
        chrome_options.page_load_strategy = 'eager'
        try:
            driver = webdriver.Chrome(options=chrome_options) 
            timeout = 10
            driver.implicitly_wait(timeout)
            driver.get(url)
            # wait = WebDriverWait(driver, 100)
            time.sleep(3)
        except WebDriverException as e:
            print("=================first driver       errpr ===============")
            driver.delete_all_cookies()
            driver.execute_script("window.localStorage.clear()")
            driver.execute_script("window.sessionStorage.clear()")
            driver.execute_cdp_cmd("Network.clearBrowserCache", {})
            driver.quit()
            time.sleep(2)
            get_product_links(url,file_name, count=1)
          # Wait for 3 seconds
        print("===================product stared",time.time()-star,"===============",url)
        
        html = driver.page_source
        driver.delete_all_cookies()
        time.sleep(0.5)
        driver.execute_script("window.localStorage.clear()")
        time.sleep(0.5)
        driver.execute_script("window.sessionStorage.clear()")
        time.sleep(0.5)
        driver.execute_cdp_cmd("Network.clearBrowserCache", {})
        time.sleep(0.5)
        driver.quit()
        soup = BeautifulSoup(html, 'html.parser')
        del html
        products = soup.find_all('div', {'class': 'css-1psrdco'})
        del soup
        for product in products:
            name = product.find('a', {'class': 'css-1k3ukvl'}).get_text()
            price_value = product.find('span', {'class': 'css-1qfcjyj ehnxcr60'}).get_text()
            point_price = product.findAll('span', {'class': 'css-dpcpx8'})
            for value in point_price:
                if point_price and isinstance(value.get_text() ,str) and value.get_text()  != "$":
                    price_value = price_value+"."+value.get_text()
            product_link = product.find('a', {'class': 'css-to413w'}).get('href') 
            del product
            urlssss = base_url + product_link
            
            product_links.append((name,price_value,urlssss))
            del name,price_value,point_price,product_link
        print("===================product peuduct ex",time.time()-star)
        del products 
    except Exception as ex:
        print(ex,"==========================ex")
        try:
        
            driver.delete_all_cookies()
        except Exception as ex:
            pass
        try:
            driver.execute_script("window.localStorage.clear()")           
        except WebDriverException as e:
            print("==========failed to access")
            pass
        
        try:
            driver.execute_script("window.sessionStorage.clear()")          
        except WebDriverException as e:
            print("==========failed to access")
            pass
        try:
            driver.execute_cdp_cmd("Network.clearBrowserCache", {})          
        except WebDriverException as e:
            print("==========failed to access")
            pass
        
        try:
            driver.quit()         
        except WebDriverException as e:
            print("==========failed to access")
            pass
        get_product_links(url,count)
    return product_links
    


def get_html_resources(file_name,url):  
    
    products_links = []
    next_products = True
    count = 1
    while next_products :
        strt__ = time.time()
        products =  get_product_links(url,file_name,count)
        print(len(products),"======================len products",time.time()-strt__)
        # if products > 0 :
        #     count +=1
        if len(products) > 0:
            if os.path.exists(file_name):
                read_data = read_to_txt(file_name)
                read_data.extend(products)
                write_to_txt(file_name,read_data)
                time.sleep(3)
            else:
                write_to_txt(file_name,products)
            count +=1
            
        else:
            next_products == False
            break
    print("===========completed")      
    return products_links


def write_to_txt(file_name,row):
    with open(file_name, 'w') as txtfile:
            json.dump(row,txtfile)
        
        
def read_to_txt(file_name):
    with open(file_name, 'r') as txtfile:
        data = json.load(txtfile)
        return data

def copy_csv(source_file, destination_file):
    with open(source_file, 'r', newline='') as csv_file:
        reader = csv.reader(csv_file)
        with open(destination_file, 'w', newline='') as output_file:
            writer = csv.writer(output_file)
            writer.writerows(reader)
    os.remove(source_file)

def test(sub_category_link):
    category_info = sub_category_link.split('/')
    category_name =   category_info[-2] +">"+ category_info[-1]  
    file_name = category_info[-2] +"_"+ category_info[-1]+".txt"
    print(file_name,"===========filename")
    if not os.path.exists(file_name):
        print("=file not exist")
        get_html_resources(file_name,sub_category_link)
    else:
        destination_file = file_name
        source_file = "copy_"+category_info[-2] +"_"+ category_info[-1]+".txt"
        get_html_resources(source_file,sub_category_link)
        copy_csv(source_file,destination_file)
        
        
        
for __url in data_list:
    test(__url)
    time.sleep(2)

    
